<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplicity Testing Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/esprima@4.0.1/dist/esprima.min.js"></script>
    <!--Import modul esprima (javascript: (const esprima = require('esprima')) <<perlu npm install esprima)-->
    <link rel="stylesheet" href="../styles/navbar.css">
    <link rel="stylesheet" href="../styles/testing-section.css">
    <style>
        body {
            display: flex;
        }

        .testing{
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        #result {
            margin-top: 20px;
        }

        .info-button, .help-button {
            cursor: pointer;
            font-size: 18px;
            background: none;
            background-color: green;
            color: white;
            padding: 0.5rem;
            border-radius: .5rem;
        }

        #codePreview {
            white-space: pre-wrap;
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px solid #ddd;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-overflow">
            <div class="logo">
                <img src="https://upload.wikimedia.org/wikipedia/id/c/c6/Logo_UIN_Sunan_Kalijaga.png" alt="UIN SUKA">
            </div>
            <div class="links">
                <a href="../availibility/" class="link">Availability</a>
                <a href="../conciseness/" class="link">Conciseness</a>
                <a href="../consistency/" class="link">Consistency</a>
                <a href="../error-tolerance/" class="link">Error Tolerance</a>
                <a href="../instrumentation/" class="link">Instrumentation</a>
                <a href="../load-testing/" class="link">Load Testing</a>
                <a href="../modularity/" class="link">Modularity</a>
                <a href="../performance-efficiency/" class="link">Performance Efficiency</a>
                <a href="../complexity/" class="link">Complexity</a>
                <a href="../security-accountability/" class="link">Security Accountability</a>
                <a href="../self-documentation/" class="link">Self Documentation</a>
                <a href="../simplicity/" class="link">Simplicity</a>
                <a href="../time-behavior/" class="link">Time Behavior</a>
                <a href="../ui-functionality/" class="link">UI Functionality Testing</a>
                <a href="../code-quality/" class="link">Code Quality</a>
            </div>
        </div>
    </nav>
    <div class="testing-section">
        <div class="testing">
            <h1>Simplicity Testing</h1>
            <input type="file" id="fileInput">
            <button class="info-button" id="infoButton">i</button> <!-- tombol ! -->
            <button class="help-button" id="helpButton">?</button> <!-- tombol ? -->
            <button id="analyzeButton">Analyze</button>
            <div id="result"></div> <!-- isi hasil -->
            <div id="codePreview"></div> <!-- isi kode -->
            <div id="info" style="display: none;"> <!--Isi tombol !-->
                <h2>Program Information</h2>
                <p>This program analyzes the cyclomatic complexity, lines of code (LOC), and Halstead metrics of a given
                    JavaScript file. It then calculates a Simplicity Score based on these metrics.</p>
                <p><strong>Cyclomatic Complexity:</strong> Measures the number of linearly independent paths through the
                    program's source code.</p>
                <p><strong>Lines of Code (LOC):</strong> The total number of lines in the code.</p>
                <p><strong>Halstead Metrics:</strong> Based on the number of operators and operands in the code.</p>
                <p><strong>Simplicity Score:</strong> A combined metric calculated using the formula:</p>
                <pre>Simplicity Score = (1 / Cyclomatic Complexity + 1 / LOC + 1 / Halstead Volume) / 3 * 1000</pre>
            </div>
            <div id="help" style="display: none;"> <!--Isi tombol ?-->
                <h2>How to Use</h2>
                <p>1. Click the "Choose File" button to select a JavaScript file from your computer.</p>
                <p>2. Click the "Analyze" button to analyze the selected file.</p>
                <p>3. The results, including Cyclomatic Complexity, LOC, Halstead Metrics, and Simplicity Score, will be
                    displayed below.</p>
            </div>
        </div>
    </div>

    <script>
        // Hitung Cyclomatic Complexity
        function calculateCyclomaticComplexity(code) {
            try {
                const syntax = esprima.parseScript(code, { tolerant: true, loc: true });
                let complexity = 1;

                function traverse(node) {
                    switch (node.type) {
                        case 'IfStatement':
                        case 'ForStatement':
                        case 'WhileStatement':
                        case 'DoWhileStatement':
                        case 'SwitchCase':
                            complexity++;
                            break;
                    }

                    for (const key in node) {
                        if (node[key] && typeof node[key] === 'object') {
                            traverse(node[key]);
                        }
                    }
                }

                traverse(syntax);
                return complexity;
            } catch (error) {
                console.error('Error parsing code:', error);
                return null;
            }
        }

        // Hitung jumlah baris
        function calculateLinesOfCode(code) {
            return code.split('\n').length;
        }

        // Hitung Halstead Metrics
        function calculateHalsteadMetrics(code) {
            try {
                const syntax = esprima.parseScript(code, { tolerant: true, loc: true });
                let operators = new Set();
                let operands = new Set();
                let operatorCount = 0;
                let operandCount = 0;

                function traverse(node) {
                    switch (node.type) {
                        case 'BinaryExpression':
                        case 'LogicalExpression':
                        case 'UnaryExpression':
                        case 'UpdateExpression':
                        case 'AssignmentExpression':
                            operators.add(node.operator);
                            operatorCount++;
                            break;
                        case 'Identifier':
                            operands.add(node.name);
                            operandCount++;
                            break;
                        case 'Literal':
                            operands.add(node.value);
                            operandCount++;
                            break;
                    }

                    for (const key in node) {
                        if (node[key] && typeof node[key] === 'object') {
                            traverse(node[key]);
                        }
                    }
                }

                traverse(syntax);

                const n1 = operators.size;
                const n2 = operands.size;
                const N1 = operatorCount;
                const N2 = operandCount;

                const vocabulary = n1 + n2;
                const length = N1 + N2;
                const volume = length * Math.log2(vocabulary);

                return { vocabulary, length, volume };
            } catch (error) {
                console.error('Error parsing code:', error);
                return null;
            }
        }

        // Hitung skor simplicity
        function calculateSimplicityScore(complexity, loc, halsteadVolume) {
            if (complexity === null || halsteadVolume === null) {
                return 'Error calculating simplicity score due to parsing errors.';
            }

            const normalizedComplexity = 1 / complexity;
            const normalizedLoc = 1 / loc;
            const normalizedHalsteadVolume = 1 / halsteadVolume;

            const simplicityScore = (normalizedComplexity + normalizedLoc + normalizedHalsteadVolume) / 3 * 1000;
            return simplicityScore;
        }

        // Listener file javascript
        document.getElementById('analyzeButton').addEventListener('click', function () {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file first.');
                return;
            }

            // baca isi file
            const reader = new FileReader();
            reader.onload = function (event) {
                const code = event.target.result;
                const complexity = calculateCyclomaticComplexity(code);
                const loc = calculateLinesOfCode(code);
                const halstead = calculateHalsteadMetrics(code);
                const simplicityScore = calculateSimplicityScore(complexity, loc, halstead ? halstead.volume : null);

                // hasil analisa
                document.getElementById('result').innerHTML = `
                    <p>Cyclomatic Complexity: ${complexity !== null ? complexity : 'Error'}</p>
                    <p>Lines of Code (LOC): ${loc}</p>
                    <p>Halstead Metrics:</p>
                    <ul>
                        <li>Vocabulary: ${halstead ? halstead.vocabulary : 'Error'}</li>
                        <li>Length: ${halstead ? halstead.length : 'Error'}</li>
                        <li>Volume: ${halstead ? halstead.volume.toFixed(2) : 'Error'}</li>
                    </ul>
                    <p><strong>Simplicity Score:</strong> ${simplicityScore}</p>
                    <p><strong>Preview kode</strong></p>
                `;

                // menampilkan isi file
                document.getElementById('codePreview').innerText = code;
            };

            reader.readAsText(file);
        });

        // utk menampilkan tombol ! dan ?
        document.getElementById('infoButton').addEventListener('click', function () {
            const infoDiv = document.getElementById('info');
            infoDiv.style.display = infoDiv.style.display === 'none' ? 'block' : 'none';
        });
        document.getElementById('helpButton').addEventListener('click', function () {
            const helpDiv = document.getElementById('help');
            helpDiv.style.display = helpDiv.style.display === 'none' ? 'block' : 'none';
        });
    </script>
</body>

</html>